\chapter{Первый проект: blink}\label{blink}

\bigskip
\includegraphics[width=\textwidth]{blink/125.jpg}

\bigskip
\includegraphics{blink/126.jpg}

\bigskip
\includegraphics[width=\textwidth]{blink/15.jpg}

\section{Настройки проекта в Keil}

Настройки проекта вызываются из меню \menu{Project>Options for Target 'ARMatura'\ldots},
комбинацией клавиш \keys{\Alt+F7},
или выбором аналогичной опции
из контекстного меню, вызываемого щелчком правой кнопкой мыши на корне дерева проекта \directory{ARMatura/}
в левом окне \keys{Project}. 

\bigskip
\includegraphics[width=\textwidth]{blink/16.jpg}
\bigskip

По умолчанию открывается вкладка \menu{Target:}

\bigskip
\includegraphics{blink/17.jpg}
\bigskip

\begin{tabular}{r l l}
& STM32F407VG \ref{STM32F407VGT} & текущий процессор \\
Xtal (MHz) & 8.0 & частота внешнего кварца \\ & & на платах Discovery обычно стоит 8 \\
Operating system: & None & или ОСРВ Keil RTX \\
Use MicroLIB & & использовать libc от Keil \\
Floating Point Hardware: & Not Used & для \cortex{M4} доступен аппаратный FPU \\
\end{tabular}

На этой вкладке также прописывается карта встроенной и внешней памяти Flash/SRAM.

\bigskip

При необходимости собрать проект под другой процессор открываем вкладку \menu{Device},
переконфигурируем проект под другую плату -- STM32VLDISCOVERY \ref{STM32VLDISCOVERY}:

\bigskip
\includegraphics{blink/18.jpg}
\bigskip

Обратите внимание что на вкладке \menu{Target} изменился чип и настройки памяти:

\bigskip
\includegraphics{blink/19.jpg}
\bigskip

\menu{Output}\ Настройки выходных файлов: каталог для бинарных файлов прошивки = firmware, при необходимости
можно использовать .hex файл прошивки, имя файла прошивки

\bigskip
\includegraphics{blink/20.jpg}
\bigskip

\bigskip
\includegraphics{blink/21.jpg}
\bigskip

\menu{Listing}\ Настройки генерации ассемблерных листингов в тот же каталог с прошивкой 

\bigskip
\includegraphics{blink/22.jpg}
\bigskip

\bigskip
\includegraphics{blink/23.jpg}
\bigskip

\menu{User}\ Запуск пользовательских программ во время сборки проекта: пока не используем

\bigskip
\includegraphics{blink/24.jpg}
\bigskip

\menu{C/C++}\ Настройки компилятора \cpp: опции оптимизации, каталоги библиотек и включаемых .h файлов,
в нижнем поле прописывается полная командная строка вызова компилятора, которая может
вам в дальнейшем понадобится, если потребуется компилировать без использования Keil IDE.

\bigskip
\includegraphics{blink/25.jpg}
\bigskip

\menu{Asm}\ Настройки ассемблера, приблизительно те же что и для \cpp

\bigskip
\includegraphics{blink/26.jpg}
\bigskip

\menu{Linker}\ Настройки линкера, который собирает объектные файлы .o, в которые компилируются каждый программный
файл (модуль) по отдельности, в один готовый файл прошивки (настройки карты памяти контроллера, адреса
точки входа программы и т.п.)

\bigskip
\includegraphics{blink/27.jpg}
\bigskip

\menu{Debug}\ Настройки отладки с помощью адаптера -- STlink (внешний или встроенный в оценочную плату), JTAG.

\bigskip
\includegraphics{blink/28.jpg}
\bigskip

Настройки адаптера STlink -- включаем режим SWD для варианта встроенного на оценочную плату,
и обнаруживаем что не установили пакет поддержки STlink и драйвера.

\bigskip
\includegraphics{blink/29.jpg}
\bigskip

\bigskip
\includegraphics{blink/30.jpg}
\bigskip

\menu{Utilities}\ Настраиваем в качестве программатора для прошивки тот же STlink

\bigskip
\includegraphics{blink/31.jpg}
\bigskip

Сохраняем настроенный проект

\bigskip
\includegraphics[width=\textwidth]{blink/32.jpg}
\bigskip

\section{Структура файлов}

\dirtree{%
.1 ARMatura.
.2 startup \DTcomment{код инициализации ядра процессора}.
.3 keil\_startup\_stm32f4xx.s \DTcomment{ассемблерный код инициализации}.
.3 system\_stm32f4xx.c \DTcomment{сишный код инициализации STM32F4}.
.4 system\_stm32f4xx.h \DTcomment{сишный код инициализации STM32F4}.
.4 stm32f4xx.h \DTcomment{STM32F4 CMSIS Cortex-M4 Device Peripheral}.
.5 core\_cm4.h \DTcomment{CMSIS библиотека поддержки ядра \cortex{M4}}.
.5 stdint.h \DTcomment{стандартные целые типы \cpp}.
.5 core\_cmInstr.h \DTcomment{CMSIS Core Instruction Interface}.
.5 core\_cmFunc.h \DTcomment{CMSIS Core Register Access Functions}.
.5 core\_cm4\_simd.h \DTcomment{CMSIS \cortex{M4} расширение SIMD/DSP}.
.2 blink.
.3 blink.c \DTcomment{простая программа мигания светодиодом или дрыгания ногой}.
.4 stm32f4xx.h.
}

\bigskip

В отличие от кристаллов типа Atmel AVR, при программировании для архитектуры \cortex{Mx}
принято использовать готовую библиотеку \cmsis, 
для которой проводится активная стандартизация среди производителей процессоров.

\bigskip
\menu{Cortex>Microcontroller>Software>Interface>Standard}
\bigskip 

\bigskip
\url{http://www.arm.com/products/processors/cortex-m/cortex-microcontroller-software-interface-standard.php}
\bigskip

Кроме основной части \cmsis, общей для всех производителей МК \cortex{Mx}, каждый подставщик
предоставляет аппаратно-зависимую часть библиотеки:
\begin{itemize}
  \item стартовый код инициализации ядра процессора
  \item библиотеку периферии например STM32F Standard Peripherial Library, включающую код
  обеспечивающий доступ к устройствам, встроенным в кристалл в т.ч.
  \item USB OTG Host \& Device 
  \item DSP/SIMD Extension (для \cortex{M4F}) системо-зависимую часть расширения \cmsis\ DSP
\end{itemize}

\bigskip
Библиотеки доступны для загрузки тут:

\bigskip
\paragraph{STSW-STM32065}

STM32F4 DSP and standard peripherals library, including 82 examples for 26 different peripherals and template project for 5 different IDEs

\url{http://www.st.com/st-web-ui/static/active/en/st_prod_software_internet/resource/technical/software/firmware/stm32f4_dsp_stdperiph_lib.zip}
\bigskip

\section{blink.c}

Сначала поcмотрим код основной программы:

\lstinputlisting[
	label=blink.c,
	caption={[blink.c]/src/blink/blink.c},
	emph={stm32f4xx}
]{../src/blink/blink.c}

Как видим --- в ней нет абсолютно ничего сложного: только подключение библиотеки
нашего МК и единственная функция \lstinline+int main(void)+, содержащая только 
возврат в стартовый код \cmsis\ значения по умолчанию --- 0.

\bigskip

Файл \verb+stm32f4xx.h+ подробно рассмотрен в \ref{stm32f4xx.h}\ --- на текущем
слое знаний не стоит в него углубляться: он слишком большой и содержит практически
весь список функционала, обеспечиваемый \cmsis.

То же самое можно сказать и о других файлах --- все они относятся либо к библиотеке
\cmsis, либо к файлам поддержки производителя чипов.

Подробности будут рассмотрены далее в разделе \ref{cmsis}, а пока важнее получить
практический результат.
  

